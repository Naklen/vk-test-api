# Api Users
**Тестовое задание для стажировки Backend-разработчик .NET в VK**

## Описание
Этот проект представляет собой API приложение ASP.NET Core, реализованное с использованием PostgreSQL в качестве СУБД и EntityFrameworkCore в качестве ORM. Проект содержит набор методов для управления пользователями, а также возможность авторизации и пагинации.

## Установка
1. Склонировать репозиторий

        https://github.com/Naklen/vk-test-api.git
2. Нужно создать файл appsettings.json в корне проекта и настроить в соответсвии с шаблоном, который лежит в файле appsettings_template.json
    * Указать строку подключения к базе данных Postgres. Например:
            
            "ConnectionStrings": {
                "DefaultConnection": "Host=localhost;Port=5432;Database=your_database_name;Username=your_username;Password=your_password"
            }
    * Указать данные для Basic-авторизации
            
            "BasicCredentials": {
                "login": "login",
                "password": "password"
            }
3. Запустить проект из IDE или с помощью команды

        dotnet run

## Использование API
Использовать API можно с помощью любого HTTP-клиента (cURL, Postman и т.п.). Также можно использовать Swagger, начальная страница которого открывается при запуске приложения в режиме разработки.

### Basic-авторизация
При использовании HTTP-клиента в заголовке Authorization HTTP запроса необходимо передавать login и password, указанные в appsettings.json. Если заголовок не указать или указать непавильные данные, будет возвращен ответ с кодом 401.

При использовании API с помощью Swagger при первом запросе приложение посылает challenge и браузер отображает стандартное окно ввода login и password.

### Получение пользователей
Получение пользователей производится HTTP-методом GET
* `GET /api/user` - получение всех пользователей
* `GET /api/user/{id}` - получение пользователя по его Id
* `GET /api/user/paginate?limit={limit}&offset={offset}` - получение пользователей с пагинацией

В случае если в базе данных нет пользователей, то метод получения всех пользователей вернет пустой JSON массив. То же самое произойдет, если в методе пагинации указать параметры, при которых в результат не попадает ниодно значение, например, limit=0 или offset больше, чем пользователей вообще.

При указании limit или offset меньше 0, будет возвращен ответ с кодом 400 и телом
> Wrong parameters 

При указании Id пользователя, которого нет в базе данных, при использовании метода получения конкретного пользователя, будет возвращен ответ с кодом 404.

### Добавление пользователей
Добавление пользователей производится HTTP-методом POST
* `POST /api/user` - добавление пользователя

При добавлении пользователя в теле запроса должна быть передана информация об этом пользователе в формате JSON
```
{
  "login": "string",
  "password": "string",
  "isAdmin": true
}
```

Если в базе данных уже находится пользователь с `user_group.code` = `"Admin"` и `user_state.code` = `"Active"`, то, при попытке добавть пользователя с флагом `isAdmin` равным `true`, будет возвращен ответ ответ с кодом 400 и сообщением 
> Active admin user already exist

При попытках добавить пользователя с одинаковым именем чаще, чем раз 5 секунд, будет возвращатся ответ с кодом 400 и сообщением
> To many requests with login {login}

### Удаление пользователей
Добавление пользователей производится HTTP-методом DELETE
* `DELETE /api/user/{id}` - удаление пользователя по его Id

При удалении пользователя происходит т.н. "мягкое удаление", то есть пользователь не удаляется из базы данных фактически, а помечается `user_state.code` = `"Blocked"`.

При попытке удалить несуществующего пользователя, возвращается ответ с кодом 404.

При попытке удалить пользоватеся с `user_state.code` = `"Blocked"`, возвращается ответ с кодом 400 и сообщением
> User {user.Login} already blocked

## Тестиование
В проекте еcть подпроект с unit-тестами на базе фреймворка xUnit. Тесты проверяют работоспособность контроллера UserController, в котором реализован функционал методов API.

## Наполнение тестовыми данными
В appsettings.json есть поле булевское `"SampleData"`, которое указывает, нужно ли при первичном создании базы данных наполнять ее тестовыми данным.